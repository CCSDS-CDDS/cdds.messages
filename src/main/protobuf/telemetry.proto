syntax = "proto3";

package ccsds.cdds;

import "types.proto";

/**
 * The Telemetry Message transports either a telemetry Data message or a Sync Notify message
 * The message shall deliver a telemetry frame from a CDDS Provider to a CDDS User.
 */
message TelemetryMessage {
  /** 
   * The sequence number allows a detection of duplicates, reordering or gaps caused by the 
   * transport technology from the CDDS Telemetry Provider to the CDDS Telemetry user.
   *  
   * This sequence number is not to be confused with the dataLinkContinuity
   * indicating the data continuity of frames as received from the space link.
   */
  optional int64 sequenceNumber = 1; 
  
  oneof data {
    TelemetryData telemetry = 2;    // Set if the message carries telemetry data
    SyncNotify syncNotify = 3;      // Set if the message carries a sync notify
  }
}

/**
 * TelemetryData holds the received telemetry frame and associated meta data.
 */
message TelemetryData {

  /**
   * The reception meta data provide the meta data of aperture(s) involved
   * in data transfer received the provide telemetry data. Typically that is for a ground station the 
   * earth receive time and aperture ID, but in case relays are involved, the involved
   * relay apertures and reception times can be provided as part of the meta data.
   */
  repeated ReceptionMetaData metaData = 1;

  /**
   * The frameQuality shall indicate the result of the forward error correction decoding
   * Default: good
   * Note: The frame quality is always good for frames delivered for a service endpoints with 
   * a defined Global Virtual Channel Identifier. 
   * or Frame Error Control Field evaluation and shall contain one of the
   * following values:
   * <br/><br/>
   * a) ‘good’ No error was detected by the decoder
   * <br/><br/>
   * b) ‘erred’ An error was detected by the decoder
   * <br/><br/>
   * c) ‘undetermined’ – the results of the decoding process for this frame are not specified or no decoding was performed.
   * <br/><br/>
   */
  optional FrameQuality frameQuality = 2;

  /**
   * 0..N privateAnnotation shall be used to convey additional information that
   * may be associated with a frame. The content of private annotations must be agreed by the 
   * CDDS user and CDDS provider before use.
   */
  repeated Annotation privateAnnotation = 3;

  /**
   * The data shall be the telemetry frame acquired from the selected 
   * channel for delivery to the CDDS User. It is a TM Transfer Frame, an AOS Transfer Frame, or a
   * USLP Transfer Frame. If the frameQuality is provided and good, or the gvcId is provided, data carries
   * the un-coded telemetry frame.
   * <br/><br/> 
   * For Reed-Solomon, LDPC or turbo encoding, if the frameQuality is provided and indicates 'ERRED',
   *  data carries the full coded block of data 
   * as identified by the frame synchronization process. For BCH encoded frames failing the decoding,
   * the result of the BCH decoding including the fill bits for which decoding was not possible is delivered.
   */
  bytes data = 4;
}

/**
 * The CDDS provider shall invoke the SyncNotify to
 * notify the CDDS user of the occurrence of an event affecting the production of the provided service.
 */
message SyncNotify {
  
  /**
   * The date and time at which event underlying the notification occurred.
   */
  DateTime time = 1;

  /**
   * The apertureId shall indicate for which aperture or antenna
   * the notification is provided. That is typically the aperture or antenna
   * of a ground station, but in case relays are involved the apertureId can be of relay.
   */
  ApertureId apertureId = 2;  

  oneof notification { 
    /**
     * The frameSyncStatus notification is sent by the CDDS Provider to notify the CDDS user
     * of a change of the frame synchronization status. 
     */
    LockStatus frameSyncStatus = 3;

    /**
     * The productionState notification is sent by the CDDS Provider to notify the CDDS user
     * of a change of the production status. 
     */
    ProductionState productionState = 4;

    /**
     * The dataDiscarded notification is sent by the CDDS Provider to the CDDS User in case
     * the CDDS Provider had to discard data due to excessive backlog of data causing an overrun
     * of the internal buffering capabilities. This is a non-nominal case.
     */
    int64 dataDiscarded = 5;  // The dataDiscarded reports on the number of data discarded due to excessive backlog

    /**
     * The endOfData notification is sent by the CDDS Provider to the CDDS User
     * when there is no more data to send. 
     */
    bool endOfData = 6; 
  }
}
