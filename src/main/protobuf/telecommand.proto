syntax = "proto3";

package ccsds.cdds;

import "types.proto";

/**
 * Telecommand Messages are sent from the CDDS User to the CDDS Provider.
 */
message TelecommandMessage {
    oneof request {
        /**
         * Request the radiation of a Telecommand.
         */
        TelecommandRadiationRequest radiationRequest = 1;

        /**
         * Request reporting of the general status of the CDDS Provider
         * or a specific Telecommand Radiation Request.
         */
        TelecommandStatusReportRequest reportRequest = 2;
    }
}

/**
 * A Telecommand radiation Request Is sent from CDDS User to a CDDS Provider.
 * It transports either a CLTU or an uncoded Telecommand Frame for radiation
 * by the CDDS Provider. 
 */
message TelecommandRadiationRequest {

    /**
     * The Command ID uniquely identifying the CLTU or telecommand within the one dedicated pass.
     */
    int64 commandId = 1;

    /**
     * Used to request reports for each Telecommand Message or not.<br/>
     * Default: PRODUCE_REPORT
     */
    optional ReportRequest reportRequest = 2;

    /**
     * An optional time specifying the earliest allowed radiation time of this Telecommand.
     * One of the checks on the Telecommand Radiation Request failed
     */
    optional DateTime earliestRadiationTime = 3;              

    /**
     * An optional time, specifying the latest allowed radiation time of this Telecommand.
     */
    optional DateTime latestRadiationTime = 4;

    /**
     * The CLTU or Telecommand Frame for radiation. In case of a Telecommand Frame, the encoding 
     * has to be agreed among the CDDS User and the CDDS Provider. 
     */ 
    oneof  data {
        /**
         * A valid CLTU as specified in CCSDS 231.0
         */
        bytes cltu = 5;

        /**
         * A valid telecommand frame as specified in CCSDS 232.0 (TC Frame), CCSDS 732.0 (AOS), CCSDS 732.1 (USLP) or a private specification
         */
        bytes telecommandFrame = 6;
    }
}

message TelecommandStatusReportRequest {
    /**
     * The Command ID uniquely identifying the telecommand within the one dedicated pass.
     * If command ID is not provided in a Telecommand Report Request, the CDDS Provider
     * shall respond with a Telecommand Report reporting on the available parameters as
     * specified by the Telecommand Report. If a report for a valid commandId requested,
     * the following report is generated:
     *      a) ack        for buffered, bot not yet radiated radiation requests
     *      b) failure    for radiation request failing to radiate
     *      c) radiation  for successfully radiated radiation requests
     */
    int64 commandId = 1; 
}

/**
 * The Telecommand Report is used by the CDDS Provider to report the status of received 
 * and processed Telecommand Messages.
 */
message TelecommandReport {

    /**
     * The Command ID uniquely identifying the telecommand within the one dedicated pass.
     */
    int64 commandId = 1; 
    
    /**
     * The Production State of the CDDS Provider at the time the report was generated.
     */
    ProductionState productionState = 4;

    /**
     * The amount of buffer available at the CDDS provider to buffer Telecommands for radiation in bytes.
     */
    int64 bufferAvailable = 5;                  // The available buffer for telecommands in bytes

    /**
     * The generation time of this report at the CDDS Provider.
     */
    DateTime reportGenerationTime = 6;

    /**
     * The apertureId shall indicate which aperture or antenna 
     * was used to generate this report.
     */
    ApertureId apertureId = 7;

    oneof report {
        /**
         * Acknowledge the reception and acceptance of a Telecommand Radiation Request. 
         */
        TelecommandRadiationRequestAck ack = 8;

        /**
         * Reports on a failure related to the received radiation request,
         * the processing of it or a failure of the radiation.
         */
        TelecommandFailure failure = 9; 

        /**
         * Reports on the radiation of a Telecommand.
         */
        TelecommandRadiation radiation = 10;

        /**
         * Reports on a Production Status change at the CDDS Provider.
         */ 
        TelecommandProductionStatusChange productionStatusChange = 11;    

        /**
         * The CDDS Provider has no further buffered Telecommands to radiate.
         */
        TelecommandBufferEmpty bufferEmpty = 12;

        /**
         * Reporting on the status of the CDDS Provider
         */
        TelecommandProviderStatus providerStatus = 13;
    }
}

/**
 * Acknowledges the reception of a valid Telecommand Radiation Request.
 */
message TelecommandRadiationRequestAck {
}

/**
 * Reports a failure in processing a Telecommand Radiation request.
 */
message TelecommandFailure {

    /**
     * Provides a diagnostic code for the reported failure.
     */
    Diagnostic diagnostic = 1;
}

/**
 * Reports Telecommand Radiation
 */
message TelecommandRadiation {
    
    /**
     * The radiation start time.
     */ 
    DateTime radiationStartTime = 1;        // ReportType RADIATED
    
    /**
     * The radiation stop time
     */
    DateTime radiationStopTime = 2;         // ReportType RADIATED
}

/**
 * Reports on a Production Status change at the CDDS Provider.
 */
message TelecommandProductionStatusChange {

}

/**
 * Reports the the buffer of the CDDS Provider is empty and
 * no further telecommands are available for radiation.
 */
message TelecommandBufferEmpty {
}

/**
 * Reports the CDDS Provider Status.
 */
message TelecommandProviderStatus {

    /**
     * Reports the command ID and times of the last successful radiation.
     * If not provided, no successful radiation occurred during the pass.
     */
    TelecommandRadiation lastRadiationOk = 1;

    /**
     * The uplinkStatus parameter shall report to the user the state of the forward
     * link obtained from the CLCW present in the return telemetry stream from the spacecraft.
     */
    UplinkStatus uplinkStatus = 2; 

    /**
     * The total number of telecommand messages received during the pass.
     */
    uint64 numberOfTelecommandsReceived = 3;

    /**
     * The number of telecommand messages accepted for radiation during the pass.
     */
    uint64 numberOfTelecommandsProcessed = 4; 

    /**
     * The number of telecommands radiated during the pass.
     */
    uint64 numberOfTelecommandsRadiated = 5;
}

/**
 * The uplinkStatus parameter shall report to the user the state of the forward link.
 * The state is obtained from the CLCW present in the return telemetry stream from the spacecraft.
 */
enum UplinkStatus {
    INVALID_UPLINK_STATUS = 0;  // not initialized
    NOT_AVAILABLE = 1;          // No information about the uplink status is available
    NO_RF_AVAILABLE = 2;        // The CLCW indicates no RF available
    NO_BITLOCK = 3;             // The CLCW indicates no bit lock
    NOMINAL = 4;                // The CLCW indicates RF available and bit lock
}

/**
 * The diagnostic enumeration reports errors and failures of Telecommand processing.
 */ 
enum Diagnostic {
    INVALID = 0;                        // not initialized
    DUPLICATE_COMMAND_ID = 1;           // The received Telecommand Radiation Request used a command ID already used during the pass.
    UNABLE_TO_PROCESS = 2;              // The CDDS Provider cannot process further Telecommands due to a previous fault. TODO: That requires the concept of a blocked service and the capability to clear the fault 
    UNABLE_TO_STORE = 3;                // The CDDS Provider is not able to store the received Telecommand Radiation Request
    OUT_OF_SEQUENCE = 4;                // The received Telecommand Radiation Request used a command ID not matching the expected sequence number
    INCONSISTENT_RADIATION_TIMES = 5;   // The earliest or latest radiation times are inconsistent
    INVALID_TIME = 6;                   // The specified radiation time window does not overlap the service period
    LATE_ARRIVAL = 7;                   // The Telecommand Radiation Request arrived after the latest radiation time
    GENERIC_ERROR = 8;                  // One of the checks on the Telecommand Radiation Request failed
    OTHER_REASON = 9;                   // A not further specified error happened when processing the Telecommand Radiation Request
    RADIATION_FAILURE = 10;             // A failure happened during radiation
    EXPIRED = 11;                       // The radiation could not be done before the latest radiation time
}

/**
 * Enum to request reports for TelecommandRadiationRequest
 */
enum ReportRequest {
    INVALID_REPORT_REQUEST = 0; // not initialized
    PRODUCE_REPORT = 1;         // Produce a report for a TelecommandRadiationRequest 
    NO_REPORT = 2;              // Do not produce a report for a TelecommandRadiationRequest
}


